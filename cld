#!/bin/zsh
# ------------------------------------------------------------------------------
# Zsh Autoload Function: cld (Proxy Version)
# è¯´æ˜ï¼šä¸“ä¸º cliProxyAPI è®¾è®¡çš„ Claude Code å¯åŠ¨è„šæœ¬
# ç”¨æ³•ï¼šé€šè¿‡ deploy_cld.sh éƒ¨ç½²åˆ° fpath æˆ–ç›´æ¥æ‰§è¡Œ
# ------------------------------------------------------------------------------

_die() { echo "âŒ $1"; }

# SSH éç™»å½• shell å¸¸ç¼ºå°‘ Homebrew PATHï¼Œå…ˆè¡¥å¸¸è§è·¯å¾„
export PATH="/opt/homebrew/bin:/usr/local/bin:$PATH"

# SSH éäº¤äº’åœºæ™¯ï¼ˆå¦‚ `ssh host cld`ï¼‰æ²¡æœ‰ ttyï¼Œä¸èƒ½èµ° fzf äº¤äº’
local HAS_TTY="0"
if [[ -t 0 && -t 1 && "${TERM:-}" != "dumb" ]]; then
  HAS_TTY="1"
fi

# ä¾èµ–æ£€æŸ¥
local CLAUDE_CMD="${CLD_CLAUDE_BIN:-$(command -v claude 2>/dev/null || true)}"
if [[ -z "$CLAUDE_CMD" ]]; then
  for cand in /opt/homebrew/bin/claude /usr/local/bin/claude; do
    if [[ -x "$cand" ]]; then
      CLAUDE_CMD="$cand"
      break
    fi
  done
fi
[[ -z "$CLAUDE_CMD" ]] && { _die "æœªæ‰¾åˆ° claude å‘½ä»¤"; return 1; }
if [[ "$HAS_TTY" == "1" ]]; then
  local FZF_CMD="$(command -v fzf 2>/dev/null || true)"
  [[ -z "$FZF_CMD" ]] && [[ -x /opt/homebrew/bin/fzf ]] && FZF_CMD="/opt/homebrew/bin/fzf"
  [[ -z "$FZF_CMD" ]] && [[ -x /usr/local/bin/fzf ]] && FZF_CMD="/usr/local/bin/fzf"
  [[ -z "$FZF_CMD" ]] && { _die "æœªå®‰è£… fzf"; return 1; }
fi

# ================= é…ç½® =================
# æ”¯æŒç¯å¢ƒå˜é‡è¦†ç›–
local PROXY_BASE="${CLD_PROXY_BASE:-http://127.0.0.1:8145}"
local PROXY_KEY="${CLD_PROXY_KEY:-}"  # ä¼˜å…ˆè¯»ç¯å¢ƒå˜é‡ï¼Œé»˜è®¤ç©º

# æ£€æµ‹æ˜¯å¦å·²è®¤è¯ï¼ˆé€šè¿‡æ˜¯å¦å­˜åœ¨ .claude.jsonï¼‰
_is_authenticated() {
  local cp_dir="${1:-$CACHE_DIR/cp}"
  [[ -f "$cp_dir/.claude.json" ]]
}

# æ˜¯å¦è®¾ç½®è‡ªå®šä¹‰ BASE_URLï¼ˆå·²è®¤è¯åˆ™è®¾ç½®ï¼Œæœªè®¤è¯åˆ™ä¸è®¾ç½®è®©å®¢æˆ·ç«¯ç›´è¿å®˜æ–¹è®¤è¯ï¼‰
_would_use_base_url() {
  local cp_dir="$CACHE_DIR/cp"
  if [[ "$CLD_USE_BASE_URL" == "false" ]]; then
    return 1
  fi
  _is_authenticated "$cp_dir"
}

local CACHE_DIR="${XDG_CACHE_HOME:-$HOME/.cache}/cld"
local UI_FZF_HEIGHT="40%"
# ========================================

if [[ "${1:-}" == "-h" || "${1:-}" == "help" ]]; then
  echo "Usage: cld [cp] [model_filter] [args...]"
  echo "  cp: Connect to cliProxyAPI (Load Balanced)"
  return 0
fi

_norm_base() { echo "${1%/}"; }
_short_model() { local m="$1"; m="${m##*/}"; echo "${m%%-*}"; }

_set_title() {
  local t="$1"
  if [[ -n "$TMUX" ]]; then
    printf "\033Ptmux;\033\033]0;%s\007\033\\" "$t"
  else
    printf "\033]0;%s\007" "$t"
  fi
}

_healthcheck_proxy_base() {
  local base="$(_norm_base "$1")"
  local url="${base}/v1/models"
  command -v curl >/dev/null 2>&1 || return 0
  curl -sS -m 3 "$url" >/dev/null 2>&1
}

# è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨
# ä¼˜å…ˆä» CLD_TOML ç¯å¢ƒå˜é‡æŒ‡å®šçš„ TOML æ–‡ä»¶è¯»å–ï¼›æœªæŒ‡å®šæ—¶è‡ªåŠ¨æ¢æµ‹ providers.toml
# å†…ç½®åˆ—è¡¨ç”± deploy_cld.sh åœ¨éƒ¨ç½²æ—¶ä» providers.toml çƒ˜ç„™
_resolve_toml_file() {
  local env_toml="${CLD_TOML:-}"
  if [[ -n "$env_toml" && -f "$env_toml" ]]; then
    echo "$env_toml"
    return 0
  fi

  local -a candidates=()
  local src_path=""

  # zsh autoload/function åœºæ™¯ï¼šä¼˜å…ˆä»å‡½æ•°æ¥æºè·¯å¾„æ¢æµ‹
  if [[ -n "${funcfiletrace[1]:-}" ]]; then
    src_path="${funcfiletrace[1]%:*}"
    if [[ -n "$src_path" ]]; then
      candidates+=(
        "${src_path:A:h}/providers.toml"
        "${src_path:A:h}/../providers.toml"
      )
    fi
  fi

  # ç›´æ¥æ‰§è¡Œè„šæœ¬åœºæ™¯
  if [[ -n "${0:-}" && "${0}" != "zsh" && "${0}" != "-zsh" ]]; then
    candidates+=("${0:A:h}/providers.toml")
  fi

  # å¸¸è§å·¥ä½œç›®å½•
  candidates+=(
    "$PWD/providers.toml"
    "$PWD/../providers.toml"
  )

  local path=""
  for path in "${candidates[@]}"; do
    if [[ -f "$path" ]]; then
      echo "$path"
      return 0
    fi
  done

  return 1
}

# ä» TOML è¯»å– proxy é…ç½®
_get_proxy_config() {
  local toml="$(_resolve_toml_file 2>/dev/null || true)"
  if [[ -n "$toml" && -f "$toml" ]]; then
    local port proxy_url
    port=$(awk '/^main_port[[:space:]]*=/ { gsub(/[[:space:]]*/, "", $3); print $3; exit }' "$toml")
    proxy_url=$(awk '/^proxy[[:space:]]*=/ { gsub(/[[:space:]]*"/, "", $3); gsub(/".*$/, "", $3); print $3; exit }' "$toml")
    if [[ -n "$port" ]]; then
      echo "http://127.0.0.1:${port}"
      return
    fi
    if [[ -n "$proxy_url" ]]; then
      echo "$proxy_url"
      return
    fi
  fi
  # é»˜è®¤å€¼
  echo "http://127.0.0.1:8145"
}

_get_proxy_models() {
  local toml="$(_resolve_toml_file 2>/dev/null || true)"
  if [[ -n "$toml" && -f "$toml" ]]; then
    local models
    models=$(awk '
      /^\[routing\][[:space:]]*$/ { in_routing = 1; next }
      /^\[[^]]+\][[:space:]]*$/ {
        if (in_routing) exit
      }
      in_routing && $0 ~ /^[[:space:]]*"/ {
        line = $0
        sub(/^[[:space:]]*"/, "", line)
        sub(/".*$/, "", line)
        print line
      }
    ' "$toml")
    if [[ -n "$models" ]]; then
      echo "$models"
      return
    fi
  fi

  # --- BEGIN MODELS ---
  echo "opus4.6"
  echo "sonnet4.6"
  echo "M2.5"
  echo "g3f"
  echo "g3f.auto"
  echo "g3p.auto"
  echo "g3i"
  echo "gpt5.3"
  echo "gpt5.2"
  # --- END MODELS ---
}

local mode=""
# 1. æ¨¡å¼é€‰æ‹© (å¦‚æœæ²¡æœ‰å‚æ•°)
if [[ -n "${1:-}" && ("${1:-}" == "cp" || "${1:-}" == "official") ]]; then
  mode="$1"
  shift 1
else
  if [[ "$HAS_TTY" == "1" ]]; then
    # äº¤äº’å¼é€‰æ‹©æ¨¡å¼
    mode="$(printf "cp (Custom Proxy)\nofficial (Anthropic Official)\n" | fzf --height="$UI_FZF_HEIGHT" --layout=reverse --border --header="Select Mode" --prompt="cld> " | awk '{print $1}')"
    [[ -z "$mode" ]] && return 0
  else
    mode="${CLD_DEFAULT_MODE:-cp}"
    echo "â„¹ï¸ No TTY detected, auto mode: $mode"
  fi
fi

mkdir -p "$CACHE_DIR/$mode" >/dev/null 2>&1 || true
local -a envs=()

# æ¸…ç†ä»£ç†å’Œè®¤è¯å˜é‡ï¼Œé˜²æ­¢æ¨¡å¼é—´æ±¡æŸ“
envs+=(
  "HTTP_PROXY=" "HTTPS_PROXY=" "ALL_PROXY="
  "ANTHROPIC_AUTH_TOKEN="
  "ANTHROPIC_API_KEY="
)

# 2. æ¨¡å¼é€»è¾‘
local title=""
case "$mode" in
  cp)
    echo "ğŸš€ Mode: cliProxyAPI (Load Balanced)"
    local cp_dir="$CACHE_DIR/cp"
    mkdir -p "$cp_dir" >/dev/null 2>&1 || true

    if ! _healthcheck_proxy_base "$PROXY_BASE"; then
      _die "æ— æ³•è¿æ¥ cliProxyAPI: ${PROXY_BASE} (æ£€æŸ¥ 8145 ç«¯å£å’Œ PM2 è¿›ç¨‹)"
      return 1
    fi

    # è·å–æ¨¡å‹åˆ—è¡¨ (ä» TOML å®æ—¶è§£æ)
    local avail_models="$(_get_proxy_models)"
    [[ -z "$avail_models" ]] && { _die "æ— æ³•ä» TOML è·å–æ¨¡å‹åˆ—è¡¨"; return 1; }

    # å®šä¹‰è§’è‰²å’Œé»˜è®¤è®°å¿†æ–‡ä»¶
    local -A roles=(
      [main]="ANTHROPIC_MODEL"
      [fast]="ANTHROPIC_DEFAULT_HAIKU_MODEL"
      [opus]="ANTHROPIC_DEFAULT_OPUS_MODEL"
    )
    local -A prompts=(
      [main]="Select MAIN Model (Coding/Chat)"
      [fast]="Select FAST Model (Search/Git)"
      [opus]="Select OPUS Model (Reasoning/Plan)"
    )
    # é»˜è®¤é¡ºåº
    local -a steps=(main fast opus)

    # å¦‚æœæœ‰å‚æ•°ï¼Œå°è¯•ä½œä¸º filter å¿«é€Ÿå¯åŠ¨ main æ¨¡å‹ï¼Œå…¶ä»–å¤ç”¨ä¸Šæ¬¡è®°å¿†æˆ–é»˜è®¤
    if [[ -n "${1:-}" && ! "${1:-}" =~ ^- ]]; then
      local filter="$1"
      local match=$(echo "$avail_models" | grep -i "$filter" | head -1)
      if [[ -n "$match" ]]; then
        echo "âš¡ï¸ Fast Start: Main=$match"
        envs+=( "${roles[main]}=$match" )
        # å…¶ä»–è§’è‰²å°è¯•è¯»å–è®°å¿†ï¼Œæ²¡æœ‰åˆ™è·Ÿéš Main
        for role in fast opus; do
          local last_file="$cp_dir/last_$role"
          if [[ -f "$last_file" ]]; then
            envs+=( "${roles[$role]}=$(cat "$last_file")" )
          else
            envs+=( "${roles[$role]}=$match" )
          fi
        done
        # ç‰¹æ®Šå¤„ç†: å­ Agent
        envs+=( "CLAUDE_CODE_SUBAGENT_MODEL=$(cat "$cp_dir/last_fast" 2>/dev/null || echo "$match")" )
        shift 1

        # æ³¨å…¥å…¶ä»–åŸºç¡€å˜é‡
        envs+=(
          "ANTHROPIC_API_KEY=$PROXY_KEY"
          "CLAUDE_CONFIG_DIR=$cp_dir"
        )
        _would_use_base_url && envs+=("ANTHROPIC_BASE_URL=$(_norm_base "$PROXY_BASE")")
        # è·³è¿‡äº¤äº’
        goto_exec=true
      fi
    fi

    if [[ "$goto_exec" != "true" && "$HAS_TTY" != "1" ]]; then
      local default_main="${CLD_CP_MAIN_DEFAULT:-g3f}"
      local default_fast="${CLD_CP_FAST_DEFAULT:-$default_main}"
      local default_opus="${CLD_CP_OPUS_DEFAULT:-opus4.6}"

      local main_model="$default_main"
      local fast_model="$default_fast"
      local opus_model="$default_opus"

      [[ -f "$cp_dir/last_main" ]] && main_model="$(cat "$cp_dir/last_main")"
      [[ -f "$cp_dir/last_fast" ]] && fast_model="$(cat "$cp_dir/last_fast")"
      [[ -f "$cp_dir/last_opus" ]] && opus_model="$(cat "$cp_dir/last_opus")"

      if ! echo "$avail_models" | grep -q "^${main_model}$"; then
        main_model="$(echo "$avail_models" | head -1)"
      fi
      if ! echo "$avail_models" | grep -q "^${fast_model}$"; then
        fast_model="$main_model"
      fi
      if ! echo "$avail_models" | grep -q "^${opus_model}$"; then
        opus_model="$main_model"
      fi

      echo "ğŸ“¦ Non-interactive: Main=$main_model  Fast=$fast_model  Opus=$opus_model"
      envs+=( "${roles[main]}=$main_model" "${roles[fast]}=$fast_model" "${roles[opus]}=$opus_model" )
      envs+=( "CLAUDE_CODE_SUBAGENT_MODEL=$fast_model" )

      echo "$main_model" > "$cp_dir/last_main"
      echo "$fast_model" > "$cp_dir/last_fast"
      echo "$opus_model" > "$cp_dir/last_opus"

      envs+=(
        "ANTHROPIC_API_KEY=$PROXY_KEY"
        "CLAUDE_CONFIG_DIR=$cp_dir"
      )
      _would_use_base_url && envs+=("ANTHROPIC_BASE_URL=$(_norm_base "$PROXY_BASE")")
      goto_exec=true
    fi

    # â”€â”€ åœºæ™¯é¢„è®¾é€‰æ‹© â”€â”€
    if [[ "$goto_exec" != "true" ]]; then
      local -A scenario_main=( [Performance]=opus4.6  [Balanced]=g3f      [Economy]=g3f  [Auto]=auto )
      local -A scenario_fast=( [Performance]=g3f      [Balanced]=g3f      [Economy]=g3f  [Auto]=auto )
      local -A scenario_opus=( [Performance]=opus4.6  [Balanced]=sonnet4.6  [Economy]=g3p  [Auto]=sonnet4.6 )
      local -a scenario_names=( Auto Performance Balanced Economy Custom )

      local last_scenario_file="$cp_dir/last_scenario"
      local last_scenario=""
      [[ -f "$last_scenario_file" ]] && last_scenario="$(cat "$last_scenario_file")"

      # æ„å»º fzf åˆ—è¡¨ï¼Œä¸Šæ¬¡é€‰æ‹©ç½®é¡¶
      local scenario_list=""
      if [[ -n "$last_scenario" ]]; then
        scenario_list="$last_scenario"$'\n'
        for s in "${scenario_names[@]}"; do
          [[ "$s" != "$last_scenario" ]] && scenario_list+="$s"$'\n'
        done
      else
        for s in "${scenario_names[@]}"; do
          scenario_list+="$s"$'\n'
        done
      fi

      local scenario_prompt="Select Scenario> "
      [[ -n "$last_scenario" ]] && scenario_prompt="Select Scenario (Last: $last_scenario)> "

      local chosen_scenario
      chosen_scenario=$(echo "$scenario_list" | sed '/^$/d' | fzf --height="$UI_FZF_HEIGHT" --layout=reverse --border --header="Select Scenario" --prompt="$scenario_prompt")

      if [[ -z "$chosen_scenario" ]]; then
        # ESC: å¤ç”¨ä¸Šæ¬¡åœºæ™¯ï¼Œä¸Šæ¬¡ä¹Ÿæ— åˆ™é€€å‡º
        if [[ -n "$last_scenario" ]]; then
          chosen_scenario="$last_scenario"
          echo "   Using last scenario: $chosen_scenario"
        else
          return 0
        fi
      fi

      echo "$chosen_scenario" > "$last_scenario_file"

      if [[ "$chosen_scenario" != "Custom" ]]; then
        local auto_upgrade_file="$cp_dir/last_auto_upgrade"
        local last_auto_upgrade="Off"
        [[ -f "$auto_upgrade_file" ]] && last_auto_upgrade="$(cat "$auto_upgrade_file")"
        [[ "$last_auto_upgrade" != "On" ]] && last_auto_upgrade="Off"

        local auto_upgrade_choice=""
        local auto_upgrade_list=""
        if [[ "$last_auto_upgrade" == "On" ]]; then
          auto_upgrade_list=$'On\nOff\n'
        else
          auto_upgrade_list=$'Off\nOn\n'
        fi

        auto_upgrade_choice=$(echo "$auto_upgrade_list" | sed '/^$/d' | fzf --height="$UI_FZF_HEIGHT" --layout=reverse --border --header="Auto Upgrade (g3f.autoâ†’opus4.6)" --prompt="Auto Upgrade (Last: $last_auto_upgrade)> ")
        if [[ -z "$auto_upgrade_choice" ]]; then
          auto_upgrade_choice="$last_auto_upgrade"
          echo "   Using last auto-upgrade: $auto_upgrade_choice"
        fi
        echo "$auto_upgrade_choice" > "$auto_upgrade_file"

        local s_main="${scenario_main[$chosen_scenario]}"
        local s_fast="${scenario_fast[$chosen_scenario]}"
        local s_opus="${scenario_opus[$chosen_scenario]}"

        if [[ "$auto_upgrade_choice" == "On" && ( "$s_main" == "g3f" || "$s_main" == "g3p" ) ]]; then
          local auto_model="${s_main}.auto"
          if echo "$avail_models" | grep -q "^${auto_model}$"; then
            s_main="$auto_model"
          else
            echo "   Auto-upgrade model '$auto_model' not found, fallback to $s_main"
          fi
        fi

        echo "ğŸ“¦ Scenario: $chosen_scenario (AutoUpgrade=$auto_upgrade_choice) â†’ Main=$s_main  Fast=$s_fast  Opus=$s_opus"

        envs+=( "${roles[main]}=$s_main" "${roles[fast]}=$s_fast" "${roles[opus]}=$s_opus" )
        envs+=( "CLAUDE_CODE_SUBAGENT_MODEL=$s_fast" )

        # åŒæ­¥æ›´æ–°è§’è‰²è®°å¿†
        echo "$s_main" > "$cp_dir/last_main"
        echo "$s_fast" > "$cp_dir/last_fast"
        echo "$s_opus" > "$cp_dir/last_opus"

        envs+=(
          "ANTHROPIC_API_KEY=$PROXY_KEY"
          "CLAUDE_CONFIG_DIR=$cp_dir"
        )
        _would_use_base_url && envs+=("ANTHROPIC_BASE_URL=$(_norm_base "$PROXY_BASE")")
        goto_exec=true
      fi
    fi

    if [[ "$goto_exec" != "true" ]]; then
      # äº¤äº’å¼é€‰æ‹© 3 ä¸ªæ¨¡å‹ (Custom åœºæ™¯)
      for role in "${steps[@]}"; do
        local last_file="$cp_dir/last_$role"
        local last_val=""
        [[ -f "$last_file" ]] && last_val="$(cat "$last_file")"

        local fzf_prompt="${prompts[$role]}> "
        [[ -n "$last_val" ]] && fzf_prompt="${prompts[$role]} (Last: $last_val)> "

        # æ„å»ºåˆ—è¡¨
        local fzf_input=""
        if [[ -n "$last_val" ]]; then
           if echo "$avail_models" | grep -q "^${last_val}$"; then
             fzf_input+="$last_val"$'\n'
             fzf_input+=$(echo "$avail_models" | grep -v "^${last_val}$")
           else
             fzf_input="$avail_models"
           fi
        else
           fzf_input="$avail_models"
        fi

        local sel
        sel=$(echo "$fzf_input" | fzf --height="$UI_FZF_HEIGHT" --layout=reverse --border --header="${prompts[$role]}" --prompt="$fzf_prompt")

        # å¦‚æœå–æ¶ˆé€‰æ‹©ï¼Œå°è¯•ç”¨ä¸Šæ¬¡çš„å€¼ï¼Œå¦‚æœè¿˜æ²¡å€¼åˆ™é€€å‡º
        if [[ -z "$sel" ]]; then
          if [[ -n "$last_val" ]]; then
            sel="$last_val"
            echo "   Using last: $sel"
          else
            return 0
          fi
        fi

        # ä¿å­˜è®°å¿†
        echo "$sel" > "$last_file"
        envs+=( "${roles[$role]}=$sel" )
      done

      # è¡¥å…… Subagent (è·Ÿéš Fast)
      envs+=( "CLAUDE_CODE_SUBAGENT_MODEL=$(cat "$cp_dir/last_fast")" )

      # æ³¨å…¥åŸºç¡€å˜é‡
      envs+=(
        "ANTHROPIC_API_KEY=$PROXY_KEY"
        "CLAUDE_CONFIG_DIR=$cp_dir"
      )
      _would_use_base_url && envs+=("ANTHROPIC_BASE_URL=$(_norm_base "$PROXY_BASE")")
    fi

    # æå– Main æ¨¡å‹åç”¨äºæ ‡é¢˜
    local main_model="${envs[(r)ANTHROPIC_MODEL=*]}"
    main_model="${main_model#*=}"
    title="cld:cp:$(_short_model "$main_model")"
    ;;

  official)
    echo "ğŸš€ Mode: Official (Anthropic)"
    # ä½¿ç”¨ç³»ç»Ÿé»˜è®¤é…ç½® (~/.claude/config.json)
    # ä¸æ³¨å…¥ä»»ä½• BASE_URL æˆ– KEYï¼Œä»…è®¾ç½®æ ‡é¢˜
    envs+=( "CLAUDE_CONFIG_DIR=" )
    title="cld:off"
    ;;
esac

_set_title "$title"

# æ—  TTY æ—¶ï¼Œè‹¥æœªä¼ ä»»ä½• Claude å‚æ•°ï¼Œä¼šé™·å…¥â€œçœ‹èµ·æ¥å¡ä½â€
if [[ "$HAS_TTY" != "1" && "$#" -eq 0 ]]; then
  _die "å½“å‰æ— äº¤äº’ TTYï¼Œæ— æ³•è¿›å…¥ Claude äº¤äº’ç•Œé¢ã€‚è¯·ä½¿ç”¨: ssh -tt <host> cld cp g3f  æˆ–  cld cp g3f -p 'ä½ çš„é—®é¢˜'"
  return 2
fi

# æ‰§è¡Œ Claudeï¼Œå¹¶é€ä¼ å‰©ä½™å‚æ•°
local tty_dev=""
if [[ "$HAS_TTY" == "1" ]]; then
  tty_dev="$(tty 2>/dev/null || true)"
fi

echo "â–¶ Launching claude..."
if [[ "$HAS_TTY" == "1" && "$tty_dev" == /dev/* ]]; then
  env "${envs[@]}" "$CLAUDE_CMD" "$@" <"$tty_dev" >"$tty_dev" 2>&1
else
  env "${envs[@]}" "$CLAUDE_CMD" "$@"
fi
